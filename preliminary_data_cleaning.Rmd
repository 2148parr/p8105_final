---
title: "preliminary_data_cleaning"
output: github_document
always_allow_html: true
---

```{r setup, include=FALSE}
library(haven)
library(tidyverse)
library(plotly)
```

## Importing NHATS data and selecting only relevant variables

Using only round 5 data, included ID variable, the two variables needed for the depression risk scale (PHQ-2), gender, age, race, whether participant uses mobility devices, size of social network, whether or not they have no one to talk to, self reported memory issues causing problems, self-rated health, and whether they are happy with their living situation. 

In creating dichotomous variable phq_cat regarding depression status, phq.total was subtracted by 2 to account for the fact that total scores on the PHQ-2 should range from 0-6 (sum of two items ranging from 0-3), while scores provided in our data ranged from 1-4. Once 2 was subtracted from the total score, phq_cat was dichotomized based on a cutoff point of 3 or higher.


```{r nhats}
nhats = read_sas("./final_data/nhats_r5.sas7bdat")  %>%
  select(spid, hc5depresan1, hc5depresan2, r5dgender, r5d2intvrage, rl5dracehisp, md5canewlker, 
         sn5dnumsn, fl5noonetalk, cg5ofmemprob, hc5health, wb5truestme4) %>%
  janitor::clean_names() %>%   
  filter(hc5depresan1 > 0, hc5depresan2 > 0, sn5dnumsn >= 0)

nhats %>% 
  select(hc5depresan1, hc5depresan2)  %>% 
  rowSums(na.rm = TRUE) -> nhats$phq.total

nhats = nhats %>%
  mutate(phq.total = phq.total - 2) %>% 
  mutate(phq_cat = if_else(phq.total < 3, "Mild/No Depression", "Moderate/Severe Depression")) %>% 
  mutate(
    gender = recode(r5dgender, `1` = "Male", `2` = "Female"),
    gender = as.factor(gender)
)
```

Preliminary exploratory visualizations (need proper labels): 
# for gender - 1 male, 2 female 
# for age categories - 1 65-69, 2 70-74, 5 75-79, 4 80 - 84, 5 85-89, 6 90+
# for racehisp  - 1 white non-hispanic, 2 black non-hispanic, 3 other non-hispanic, 4, hispanic, 5 more than one/dkrf primary

```{r nhats_demo}

gender_bar = 
  nhats  %>%   
  count(r5dgender) %>% 
  mutate(r5dgender = as.factor(r5dgender),
         r5dgender = fct_reorder(r5dgender, n)) %>% 
  plot_ly(x = ~r5dgender, y = ~n, color = ~r5dgender, type = "bar", colors = "viridis") %>% 
  layout(plot_bgcolor = "f8f8f8",
         xaxis = list(title = "participant gender", tickfont = list(size = 11)), 
         yaxis = list(title = "frequency"), 
         title = "Gender",  
         titlefont = list(size = 16),
         showlegend = FALSE)

age_bar = 
  nhats  %>%   
  filter(r5d2intvrage > 0) %>% 
  count(r5d2intvrage) %>% 
  mutate(r5d2intvrage = as.factor(r5d2intvrage),
         r5d2intvrage = fct_reorder(r5d2intvrage, n)) %>% 
  plot_ly(x = ~r5d2intvrage, y = ~n, color = ~r5d2intvrage, type = "bar", colors = "viridis") %>% 
  layout(plot_bgcolor = "f8f8f8",
         xaxis = list(title = "participant age", tickfont = list(size = 11)), 
         yaxis = list(title = "frequency"), 
         title = "Age",  
         titlefont = list(size = 16),
         showlegend = FALSE)

race_bar = 
  nhats  %>%   
  filter(rl5dracehisp > 0) %>% 
  count(rl5dracehisp) %>% 
  mutate(rl5dracehisp = as.factor(rl5dracehisp),
         rl5dracehisp = fct_reorder(rl5dracehisp, n)) %>% 
  plot_ly(x = ~rl5dracehisp, y = ~n, color = ~rl5dracehisp, type = "bar", colors = "viridis") %>% 
  layout(plot_bgcolor = "f8f8f8",
         xaxis = list(title = "participant race/ethnicity", tickfont = list(size = 11)), 
         yaxis = list(title = "frequency"), 
         title = "Race/Ethnicity",  
         titlefont = list(size = 16),
         showlegend = FALSE)

demo_bar = subplot(gender_bar, age_bar, race_bar, nrows = 3) %>%
  layout(xaxis3 = list(title = "categories"), 
         yaxis2 = list(title = "frequency"),
         title = list(text = "Demographic frequencies"), 
         titlefont = list(size = 14),
         legend = list(font = list(size = 10)))

demo_bar 

```

Attempting plotting of social network size predictor against PHQ-2, stratified by race (EM)

```{r nhats_prectict}

sn_white = 
  nhats %>%   filter(rl5dracehisp == 1 ) %>% 
  plot_ly(x = ~jitter(sn5dnumsn, 1), y = ~jitter(phq.total, 1), color = ~sn5dnumsn, type = "scatter", 
          mode = "markers", marker = list(color = "red")) %>% 
  layout(plot_bgcolor = "fffefa") 

sn_black = 
  nhats %>%   filter(rl5dracehisp == 2 ) %>% 
  plot_ly(x = ~jitter(sn5dnumsn, 1), y = ~jitter(phq.total, 1), color = ~sn5dnumsn, type = "scatter", 
          mode = "markers", marker = list(color = "blue")) %>% 
  layout(plot_bgcolor = "fffefa") 

sn_other = 
  nhats %>%   filter(rl5dracehisp == 3 ) %>% 
  plot_ly(x = ~jitter(sn5dnumsn, 1), y = ~jitter(phq.total, 1), color = ~sn5dnumsn, type = "scatter", 
          mode = "markers", marker = list(color = "green")) %>% 
  layout(plot_bgcolor = "fffefa") 

sn_hisp = 
  nhats %>%   filter(rl5dracehisp == 4 ) %>% 
  plot_ly(x = ~jitter(sn5dnumsn, 1), y = ~jitter(phq.total, 1), color = ~sn5dnumsn, type = "scatter", 
          mode = "markers", marker = list(color = "orange")) %>% 
  layout(plot_bgcolor = "fffefa") 


snsize_scatter = subplot(sn_white, sn_black, sn_other, sn_hisp, nrows = 4) %>%
  layout(xaxis4 = list(title = "social network size"), 
         yaxis2 = list(title = "PHQ-2"),
         title = list(text = "Social network size and PHQ-2 score distribution"), 
         titlefont = list(size = 14),
         legend = list(font = list(size = 10)))

snsize_scatter 

```

Plotting social network and health by phq_cat:

```{r}
sn_phq = nhats %>% 
  ggplot(aes(x = sn5dnumsn, group = phq_cat)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat = "count") +
    geom_text(aes( label = scales::percent(round(..prop.., 3)),
                   y = ..prop.. ), stat = "count", vjust = -.3, size = 2.5) +
    labs(y = "Percent", fill = "SN") +
    facet_grid(~phq_cat) +
    scale_y_continuous(labels = scales::percent)

ggplotly(sn_phq)

health_phq = nhats %>% 
  filter(hc5health > 0) %>%
  ggplot(aes(x = hc5health, group = phq_cat)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat = "count") +
    geom_text(aes( label = scales::percent(round(..prop.., 3)),
                   y = ..prop.. ), stat = "count", vjust = -.3, size = 2.5) +
    labs(y = "Percent", fill = "SN") +
    facet_grid(~phq_cat) +
    scale_y_continuous(labels = scales::percent)

ggplotly(health_phq)
```


### Plotting memory x depression outcomes
 *onyeka*

```{r}
mem_plot = nhats %>%  mutate(
                          phq_cat = factor(phq_cat),
                          cane_walker_cat = factor(md5canewlker),
                          noone_talk = factor(fl5noonetalk),
                          mem_probs = factor(cg5ofmemprob)) %>% group_by(phq_cat, mem_probs) %>% 
  summarise(n = n()) %>% mutate(
  proportion = (n / sum(n))
  )

  memory_plot = mem_plot %>%  ggplot(aes(x = mem_probs, y = proportion, group= phq_cat)) + 
    geom_line()  +  
   geom_point(alpha = 0.5, color = "red") + 
    facet_grid(~phq_cat) + 
    labs( title = "Severity of memory problems and Depression outcomes",
      x = "Severity level of problems with memory", y = " Proportion of respondents")+  
    scale_x_discrete(
      labels = c("Everyday","Most days","Some days","Rarely","Never")) + 
    scale_y_continuous(labels = scales::percent)
  
  ggplotly(memory_plot)
```


### plotting cane walker use *onyeka*
```{r}
cane_plot = nhats %>%  
  mutate(
    cane_walker_cat = factor(md5canewlker)) %>% 
    filter(cane_walker_cat != -8) %>%  
    group_by(phq_cat, cane_walker_cat) %>% 
    summarise(n = n()) %>%  
    mutate(
        proportion = (n / sum(n)))

canewalker_plot = cane_plot %>%  
ggplot(aes(x = cane_walker_cat, y =proportion)) + 
  geom_col(fill= "light blue") + facet_grid(~phq_cat)+
  labs( title = "Use of cane walker wheelchair and depression outcomes",
      x = "Asked if used a cane walker wheel chair", y = " Proportion of respondents")+  
    scale_x_discrete(
      labels = c("Yes","No")) + 
    scale_y_continuous(labels = scales::percent)

  ggplotly(canewalker_plot)
```

